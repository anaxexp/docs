# Drupal stack containers

!!! info "SSH and Cron containers"
    For AnaxExp environments we additionally spin up copies of PHP services with overridden commands to run cron and ssh daemons. All environment variables added to PHP-FPM service will be automatically passed to [SSHd](#sshd) and [Crond](#crond) services.

## Nginx

* Nginx can be configured with the following [environment variables](https://github.com/anaxexp/drupal-nginx#environment-variables)
* Default Nginx virtual host config for:
    * [Drupal 8](https://github.com/anaxexp/drupal-nginx/blob/master/templates/d8-vhost.conf.tpl)
    * [Drupal 7](https://github.com/anaxexp/drupal-nginx/blob/master/templates/d7-vhost.conf.tpl)
    * [Drupal 6](https://github.com/anaxexp/drupal-nginx/blob/master/templates/d6-vhost.conf.tpl)
* Installed [nginx modules](https://github.com/anaxexp/nginx/blob/master/test/nginx_modules)

!!! warning "Do not gzip pages in Drupal"
    We already gzip content on Nginx side and it works faster. Having double gzip may cause issues. 

Restarting nginx as default user:

```shell
sudo nginx -s reload
```

### PHP endpoints

For security reasons, default nginx config allows executing limited php endpoints. This is how you can add additional php endpoints:

1. Add `*.conf` file to your codebase with locations definition, example:
```
location = /custom-php-endpoint.php {
    fastcgi_pass php;
}
```
2. In nginx service configuration set new environment variable `NGINX_SERVER_EXTRA_CONF_FILEPATH` to your *.conf file (e.g. `/var/www/html/drupal.conf`). It will be included at the end of `/etc/nginx/conf.d/drupal.conf`
3. Restart the service

Alternatively, you can replace your HTTP server to [Apache](#apache) (not recommended) that has less strict rules.

### XML endpoints

By default nginx config requests Drupal backend when `rss.xml` or `sitemap.xml` requested. If you want to add another XML endpoint generated by Drupal just set environment variable `NGINX_ALLOW_XML_ENDPOINTS` to any value and restart the service.

### Custom config

If the default drupal config and available environment variables are not enough for your customizations you can replace the config with your own:

1. Copy `/etc/nginx/conf.d/drupal.conf` to your codebase, adjust to your needs
2. Deploy code with your config file
3. Add new environment variable `NGINX_CONF_INCLUDE` for nginx service, the value should the path to your *.conf file (e.g. `/var/www/html/nginx.conf`

### Files proxy

You can proxy all requests to files to (similar to what drupal module stage_file_proxy does) by adding the environment variable `NGINX_DRUPAL_FILE_PROXY_URL` to URL of your Drupal instance with files, e.g. `http://example.com`

### Mod pagespeed

Nginx comes with [mod_pagespeed](https://www.modpagespeed.com/) which is disabled by default. To enable it add `NGINX_PAGESPEED=on` environment variable to Nginx service.

## Apache

{!stacks/_includes/containers/php-apache.md!}

## PHP

{!stacks/_includes/containers/php.md!}

#### Drupal-specific

Additionally, variable `$DRUPAL_SITE` (previous deprecated name `$ANAXEXP_APP_SUBSITE`) contains Drupal site directory, e.g. `default`.  

!!! warning "WARNING" 
    Some environment variables used by PHP may be overridden in [`anaxexp.settings.php`](index.md#drupal-settings) file
    
{!stacks/_includes/containers/php-dev.md!}

### PHPUnit

1. Inside your drupal/core directory, copy the file `phpunit.xml.dist` and rename it to `phpunit.xml`
2. Open that file and make sure that you update `SIMPLETEST_BASE_URL` to `http://nginx`
3. In order to make sure that your DB connection is working as well, update `SIMPLETEST_DB` to `mysql://drupal:drupal@mariadb/drupal`

### Drush

PHP container comes with pre-installed drush and drush launcher. Drush launcher will help you use drush that comes with your project without specifying the full path to it. 

### Drupal Console

PHP container comes with installed drupal console launcher (not the same as drupal console), the launcher used to be able run drupal console without specified the full path to it. Please note that starting Drupal Console ~1.0 you have to install it manually (via composer) per project.

## Crond

{!stacks/_includes/containers/php-crond.md!}

## SSHd

{!stacks/_includes/containers/php-sshd.md!}

## Mailhog

{!stacks/_includes/containers/mailhog.md!}

## OpenSMTPD

See [OpenSMTPD stack documentation](../opensmtpd/index.md).

## MariaDB

See [MariaDB stack documentation](../mariadb/index.md).

## Node.js

{!stacks/_includes/containers/node.md!}

## Drupal Node.js

Drupal node is a container with a server app for the [Node.js Integration Drupal module](https://www.drupal.org/project/nodejs). You can configure Node.js via environment variables that listed at https://github.com/anaxexp/drupal-node 

Usage:

1. Install [Node.js Integration Drupal module](https://www.drupal.org/project/nodejs) on your site
2. Visit the Node.js configuration page under the Configuration menu, and enter the connection information for your Node.js server application. Set host to `node` (or `drupal-node` for local environment) and service key can be found on `[Instance] > Stack > Node.js`

## Solr 

See [Solr for Drupal stack documentation](../solr-drupal/index.md).

## Memcached

{!stacks/_includes/containers/memcached.md!}

## Redis

### Drupal 8

Install [redis module](https://www.drupal.org/project/redis) and enable redis integration under `[Instance] > Cache > Settings` page of AnaxExp dashboard to use it as an internal cache storage for Drupal. All required configuration already provided in [`anaxexp.settings.php` file](index.md#drupal-settings).

### Drupal 7

Install [redis module](https://www.drupal.org/project/redis) to use it as an internal cache storage for Drupal. All required configuration already provided in [`anaxexp.settings.php` file](index.md#drupal-settings).

[Redis stack documentation](../redis/index.md)

## Varnish

Varnish ignores the following GET parameters for cache id generation:

```
utm_source
utm_medium
utm_campaign
utm_content
gclid
cx
ie
cof
siteurl
```

For more details see [Varnish stack documentation](../varnish/index.md)

### Drupal 8

Read [this article](https://wunderkraut.se/blogg/purge-cachetags-varnish) to learn how to use Varnish with Drupal 8.

### Drupal 7

1. Install and enable varnish module (use the dev version). All required configuration for this module already provided in [`anaxexp.settings.php` file](index.md#drupal-settings)
2. Go to `Home » Administration » Configuration » Development` page of Drupal website and
3. Check Cache pages for anonymous users
4. Check Compress cached pages.
Check Aggregate and compress CSS files.
Check Aggregate JavaScript files.
Also, we recommend to install expire module to configure auto purge of pages when some content has been updated. After installation go to `Home » Administration » Configuration » System` and select External expiration at the "Module status" tab.

## Rsyslog

Rsyslog can be used to stream your applications logs (watchdog). It's similar to using syslog, however there's no syslog in PHP container. Rsyslog will stream all incoming logs to a container output.

Here how you can use it with Monolog:

1. Install [monolog module](https://www.drupal.org/project/monolog). Make sure all dependencies being downloaded
2. Add new handler at `monolog/monolog.services.yml`:
```yml
monolog.handler.rsyslog:
  class: Monolog\Handler\SyslogUdpHandler
  arguments: ['rsyslog']
```
3. Rebuild cache (`drush cr`)
4. Use `rsyslog` handler for your channels
5. Find your logs in [rsyslog container output](../../apps/logs.md)

Read [Logging in Drupal 8](https://www.wellnet.it/en/blog/logging-drupal-8) to learn more.

## Blackfire

{!stacks/_includes/containers/blackfire.md!}

## Webgrind

{!stacks/_includes/containers/webgrind.md!}
